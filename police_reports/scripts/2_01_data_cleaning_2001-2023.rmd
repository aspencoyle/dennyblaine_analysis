---
title: "data_cleaning"
author: "Aspen Coyle"
date: "2024-05-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Info

This script cleans and organizes police data on reports from Denny-Blaine and other beaches, with the goal of examining police response frequency over time

#### Load libraries, and install if necessary

```{r}
# Add all required libraries here
list.of.packages <- c("tidyverse", "lubridate")
# Get names of all required packages that aren't installed
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[, "Package"])]
# Install all new packages
if(length(new.packages)) install.packages(new.packages)


# Load all required libraries
lapply(list.of.packages, FUN = function(X) {
  do.call("require", list(X))
})

```


# Download data, remove unnecessary columns

Data was downloaded from the SPD public call data page, available at https://data.seattle.gov/Public-Safety/Call-Data/33kz-ixgy

Downloaded all available data from East precinct, Charlie sector on 2024-05-18




```{r}
# Read in data
db_call_dat <- read.csv("../data/db_call_data_2001-2023.csv")

# Woof, 237,000 rows! 

# Let's narrow it down some, and only select those calls with a blurred lat/long within a quarter mile of Denny Blaine
# North boundary: 47.623689
# South boundary: 47.616472
# East boundary: -122.274502
# West boundary: -122.285688

# Filter by location
db_call_dat <- db_call_dat %>%
  dplyr::filter(Blurred_Latitude < 47.623689 & Blurred_Latitude > 47.616472) %>%    # north/south
  dplyr::filter(Blurred_Longitude < -122.274502 & Blurred_Longitude > -122.285688)  # east/west 


# Dropping unnecessary columns
# Precinct: all are East, safe to drop
# Sector: all are Charlie, safe to drop
# Beat: let's check
table(db_call_dat$Beat)
# All are C3. Regardless, safe to drop

# Can also drop Arrived Time (as non-arrived calls are blank, and we care about the date of the call over a long timeframe, not the response time)

db_call_dat <- db_call_dat %>%
  select(-c("Precinct", "Sector", "Beat", "Arrived.Time"))
```

# Explore and clean data

```{r}
# A small thing I noticed, there's a fair amount of untidy data, especially in the Final.Call.Type column.
# Using untidy data, SPD! For shame!!! 
# Let's clean that up a touch so R doesn't stumble
db_call_dat$Final.Call.Type <- str_remove(db_call_dat$Final.Call.Type, "--")


# Look at different reasons calls were made
table(db_call_dat$Initial.Call.Type)

# Alright, lots of these are non-applicable to any disorder or misconduct at Denny-Blaine.
# Let's remove all such non-applicable entries

# Remove rows with the following response types
db_call_dat <- db_call_dat %>%
  filter(Initial.Call.Type != "-ASSIGNED DUTY - FOOT BEAT (FROM ASSIGNED CAR)") %>%    # patrol
  filter(Initial.Call.Type != "ALARM - COMM, HOLD-UP/PANIC (EXCEPT BANKS)") %>%        # burglary
  filter(Initial.Call.Type != "ALARM - COMM, SILENT/AUD BURG (INCL BANKS)") %>%        # burglary
  filter(Initial.Call.Type != "ALARM - DURESS/PANIC,BUS/TAXI/CAR/PRSN - NOT DV ") %>%  # burglary (one instance, checked)
  filter(Initial.Call.Type != "ALARM - RESIDENTIAL - BURGLARY, SILENT/AUDIBLE") %>%    # burglary
  filter(Initial.Call.Type != "ALARM - RESIDENTIAL - SILENT/AUD PANIC/DURESS") %>%     # burglary
  filter(Initial.Call.Type != "ASLT - DV CRITICAL") %>%                                # domestic violence
  filter(Initial.Call.Type != "AUTO RECOVERY") %>%                                     # auto recovery
  filter(Initial.Call.Type != "BURG - COMM BURGLARY") %>%                              # burglary
  filter(Initial.Call.Type != "BURG - OCCUPIED RESD") %>%                              # burglary
  filter(Initial.Call.Type != "BURG - RESD (INCL UNOCC STRUCTURES ON PROP)") %>%       # burglary
  filter(Initial.Call.Type != "CHILD - ABAND, ABUSE, MOLEST, NEGLECT") %>%             # child abuse
  filter(Initial.Call.Type != "CHILD - CRITICAL ABAND, ABUSE, MOLEST, NEGLECT") %>%    # child abuse
  filter(Initial.Call.Type != "DISTURBANCE - DV - NO ASLT ") %>%                       # domestic violence
  filter(Initial.Call.Type != "DISTURBANCE - DV CRITICAL") %>%                         # domestic violence
  filter(Initial.Call.Type != "DOWN - CHECK FOR DOWN PERSON") %>%                      # welfare check
  filter(Initial.Call.Type != "DUI - DRIVING UNDER INFLUENCE") %>%                     # DUI
  filter(Initial.Call.Type != "FOLLOW UP") %>%                                         # follow up
  filter(Initial.Call.Type != "FOUND PERSON") %>%                                      # found person
  filter(Initial.Call.Type != "FRAUD") %>%                                             # fraud
  filter(Initial.Call.Type != "HARBOR - WATER DEBRIS, NAVIGATIONAL HAZARDS") %>%       # water hazard
  filter(Initial.Call.Type != "HARBOR - WATER EMERGENCIES") %>%                        # water emergencies
  filter(Initial.Call.Type != "HARBOR - WATER NON-EMERGENCIES") %>%                    # water non-emergencies
  filter(Initial.Call.Type != "INFORMATIONAL BROADCASTS") %>%                          # informational broadcasts
  filter(Initial.Call.Type != "JUVENILE - RUNAWAY") %>%                                # juvenile runaway
  filter(Initial.Call.Type != "JUVENILE - RUNAWAY PICKUP") %>%                         # runaway found
  filter(Initial.Call.Type != "MISSING - ADULT") %>%                                   # adult missing
  filter(Initial.Call.Type != "MISSING - CHILD") %>%                                   # child missing
  filter(Initial.Call.Type != "MVC - HIT AND RUN") %>%                                 # motor vehicle collision
  filter(Initial.Call.Type != "OBS - ACC - UNK INJURIES") %>%                          # checked, all traffic accidents
  filter(Initial.Call.Type != "OBS - ACC - WITH INJURIES (INCLUDES HIT AND RUN)") %>%  # motor vehicle collision
  filter(Initial.Call.Type != "OBS - BURG - IP/JO - COMM BURG (INCLUDES SCHOOLS)") %>% # burglary
  filter(Initial.Call.Type != "OBS - DOWN - CHECK FOR PERSON DOWN") %>%                # welfare check
  filter(Initial.Call.Type != "OBS - HIT AND RUN (NO INJURIES). INCLUDES IP/JO") %>%   # motor vehicle collision
  filter(Initial.Call.Type != "OBS - INJURED - IP/JO - PERSON/INDUSTRIAL ACCIDENT") %>%# accident
  filter(Initial.Call.Type != "OBS - MVC - NON INJURY, BLOCKING") %>%                  # motor vehicle collision
  filter(Initial.Call.Type != "OBS - MVC - UNK INJURIES") %>%                          # motor vehicle collision
  filter(Initial.Call.Type != "OBS - MVC - WITH INJURIES (INCLUDES HIT AND RUN)") %>%  # motor vehicle collision
  filter(Initial.Call.Type != "OBS - NON INJURY, BLOCKING ") %>%                       # checked, all MVCs
  filter(Initial.Call.Type != "OBS - REPORT, NON INJ/NON BLKG OR AFTER FACT INJ") %>%  # motor vehicle collision
  filter(Initial.Call.Type != "OBS - SECONDARY - FORGERY/BUNCO/SCAMS/ID THEFT") %>%    # fraud
  filter(Initial.Call.Type != "OBS - TRU - ACC - HIT AND RUN") %>%                     # motor vehicle collision
  filter(Initial.Call.Type != "OPEN - BUILDING, DOOR, ETC.") %>%                       # open building
  filter(Initial.Call.Type != "ORDER - CRITICAL VIOLATION OF DV COURT ORDER") %>%      # court order violation
  filter(Initial.Call.Type != "ORDER - VIOLATING DV COURT ORDER") %>%                  # court order violation
  filter(Initial.Call.Type != "ORDER - VIOLATION OF COURT ORDER (NON DV)") %>%         # court order violation
  filter(Initial.Call.Type != "ORDER  - SERVICE OF DV COURT ORDER") %>%                # service of court order
  filter(Initial.Call.Type != "PEACE-STANDBY TO ASSURE (NO COURT ORDR SVC)") %>%       # checked, public assistance and DV
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%
  filter(Initial.Call.Type != "") %>%


  

# Now let's manually go thru again, since we had a bunch of new call types from 2010-2017!

# Look at different reasons calls were made
table(db_call_dat$Initial.Call.Type)

# Remove ones not related to Denny-Blaine
db_call_dat <- db_call_dat %>%
  filter(Initial.Call.Type != "ALARM - AUDIBLE AUTOMOBILE (UNOCC/ANTI-THEFT)") %>%     # car alarm
  filter(Initial.Call.Type != "ALARM - DURESS/PANIC,BUS/TAXI/CAR/PRSN - NOT DV ") %>%  # car alarm
  filter(Initial.Call.Type != "ALARM - RESIDENTIAL - SILENT/AUD PANIC/DURESS") %>%     # residential alarm
  filter(Initial.Call.Type != "ASLT - DV") %>%                                         # domestic violence
  filter(Initial.Call.Type != "CUSTODIAL INTERFERENCE - DV") %>%                       # domestic violence
  filter(Initial.Call.Type != "DIRECTED PATROL ACTIVITY") %>%                          # patrol
  filter(Initial.Call.Type != "JUVENILE - RUNAWAY") %>%                                # juvenile runaway
  filter(Initial.Call.Type != "OBS - ACC - UNK INJURIES") %>%                          # accident
  filter(Initial.Call.Type != "OBS - ACC - WITH INJURIES (INCLUDES HIT AND RUN)") %>%  # MV accident
  filter(Initial.Call.Type != "OBS - DOA - CASUALTY, DEAD BODY") %>%                   # non-drug-related death
  filter(Initial.Call.Type != "OBS - DOWN - CHECK FOR PERSON DOWN") %>%                # welfare check
  filter(Initial.Call.Type != "OBS - SECONDARY - FORGERY/BUNCO/SCAMS/ID THEFT") %>%    # fraud
  filter(Initial.Call.Type != "OBS - TRU - ACC - HIT AND RUN") %>%                     # motor vehicle accident
  filter(Initial.Call.Type != "PROPERTY - FOUND") %>%                                  # found property
  filter(Initial.Call.Type != "REQUEST TO WATCH") %>%                                  # premise checks
  filter(Initial.Call.Type != "TRU - RESIDENTIAL BURGLARY") %>%                        # burglary
  filter(Initial.Call.Type != "WIRES DOWN (PHONE, ELECTRICAL,ETC.)")                   # wires down




# Alright, we've got some reports that could potentially have something vaguely to do with DB, at least according to the initial report! Let's look at the final call reports to see if we can rule anything out

table(db_call_dat$Final.Call.Type)

# Remove ones that can't be DB
db_call_dat <- db_call_dat %>%
  filter(Final.Call.Type != "BURGLARY - RESIDENTIAL OCCUPIED") %>%              # burglary, was called for disturbance
  filter(Final.Call.Type != "BURGLARY - UNOCC STRUC ON RESN PROP") %>%          # burglary, was called for disturbance
  filter(Final.Call.Type != "CASUALTY,NON-TRAF,NON-CRIM - NON-DRUG RELATED")    # dead body, non-drug-related

# Let's also do a quick check of event resolution

table(db_call_dat$Event.Clearance.Description)

# Remove false report
db_call_dat <- db_call_dat %>%
  filter(Final.Call.Type != "FALSE COMPLAINT/UNFOUNDED")
```

Cool, we've got a list of incidents that could have potentially been at DB

Let's sort these into a few neater categories - property damage/theft, lewd conduct, disturbance, drugs, traffic/parking, suspicious people

# Organizing into broad categories

```{r}
# Add new column, fill with NAs
db_call_dat$broad_category <- NA

# We'll do this in base R - sorry, I just prefer this way!

# do based on initial call type, since those have more precision
# at first, we'll just continue with all the ones defined in 1_01_data_cleaning_2018-2023
table(db_call_dat$Initial.Call.Type)

db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "ALARM - DURESS/PANIC,TAXI/CAR/PRSN - NOT DV"] <- "prop.dmg"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "BURN - RECKLESS BURNING"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "DISTURBANCE"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "HARAS - NO BIAS OR THREATS"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "LEWD -  (EXPOSING, FLASHING)"] <- "lewd"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "NUISANCE"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "OBS - DOA - CASUALTY, DEAD BODY"] <- "drugs"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "OBS - FIGHT - VERBAL/ORAL (NO WEAPONS)"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "OBS - PROWLER"] <- "susp.pers"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "OVERDOSE"] <- "drugs"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "PARKING VIOLATION (EXCEPT ABANDONED CAR)"] <- "traffic"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "PROPERTY - DAMAGE"] <- "prop.dmg"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "SEX IN PUBLIC PLACE (INCL MASTURBATION)"] <- "lewd"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "SUSPICIOUS PERSON, VEHICLE, OR INCIDENT"] <- "susp.pers"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "SUSPICIOUS STOP - OFFICER INITIATED ONVIEW"] <- "susp.pers"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "THEFT (DOES NOT INCLUDE SHOPLIFT OR SVCS)"] <- "prop.dmg"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "THREATS (INCLS IN-PERSON/BY PHONE/IN WRITING)"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "TRAFFIC - BLOCKING ROADWAY"] <- "traffic"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "TRESPASS"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "TRU - DISTURBANCE"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "TRU - PROPERTY DESTRUCTION/DAMAGE"] <- "prop.dmg"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "TRU - SEX IN PUBLIC"] <- "lewd"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "TRU - SUSPICIOUS CIRCUMSTANCES"] <- "susp.pers"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "TRU - THEFT"] <- "prop.dmg"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "URINATING, DEFECATING IN PUBLIC"] <- "lewd"

# Alright, now let's do the ones that are new to 2010-2017!
# Create a subset of the data with no broad_category value yet assigned
data_subset <- db_call_dat[is.na(db_call_dat$broad_category), ]

# Look at those new values
table(data_subset$Initial.Call.Type)

# Assign broad_category values
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "ALARM - DURESS/PANIC,BUS/TAXI/CAR/PRSN - NOT DV"] <- "prop.dmg"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "ANIMAL - DANGEROUS"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "ASLT - CRITICAL (NO SHOOTINGS)"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "BIAS"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "FIREWORKS (NO HAZARD)"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "LIQUOR VIOLATIONS - MINOR"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "NOISE - GENERAL"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "OBS - NOISE - DISTURBANCE (PARTY, ETC)"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "OBS - PROWLER - IP/JO"] <- "susp.pers"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "OBS - SECONDARY - THEFT"] <- "theft"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "PERSON IN BEHAVIORAL/EMOTIONAL CRISIS"] <- "disturbance"
db_call_dat$broad_category[db_call_dat$Initial.Call.Type == "ROBBERY (INCL STRONG ARM)"] <- "theft"






```

Nice, now we've got a slick clean (and TIDY, please take notes SPD!) dataframe. Now let's pull out the year from the date/time info!

```{r}
# Let's split the time/date string and just select the date
db_call_dat$Original.Time.Queued <- str_split_i(db_call_dat$Original.Time.Queued, " ", 1)

# Rename column
db_call_dat <- db_call_dat %>%
  rename(Incident.Date = Original.Time.Queued)

# Check column type
str(db_call_dat$Incident.Date)
# Yep it's a character string

# Transform into Date object type
db_call_dat$Incident.Date <- mdy(db_call_dat$Incident.Date)
# Check it worked
str(db_call_dat$Incident.Date)

# Write everything out
write.csv(db_call_dat, file = "../output/potential_db_calls_2010-2023.csv", row.names = FALSE)
```
Alright, next step: creating visualizations looking at trends by year!



